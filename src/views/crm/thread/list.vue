<template>
    <div class="page-body B2b thread">
        <div class="page-body-cont">
            <div class="query-cont__row">
                <div class="query-cont__col">
                    <div class="query-col__label">客户手机号：</div>
                    <div class="query-col__input">
                        <el-input v-model="queryParams.userMobile" placeholder="请输入客户手机号" maxlength="13" clearable></el-input>
                    </div>
                </div>
                <div class="query-cont__col">
                    <div class="query-col__label">客户姓名：</div>
                    <div class="query-col__input">
                        <el-input v-model="queryParams.userName" placeholder="请输入客户姓名" maxlength="50" clearable></el-input>
                    </div>
                </div>
                <div class="query-cont__col">
                    <div class="query-col__label">企业名称：</div>
                    <div class="query-col__input">
                        <el-input v-model="queryParams.companyName" placeholder="请输入企业名称" maxlength="50" clearable></el-input>
                    </div>
                </div>
                <div class="query-cont__col">
                    <div class="query-col__label">线索来源：</div>
                    <div class="query-col__input">
                        <el-select v-model="queryParams.origin" placeholder="请选择" clearable>
                            <el-option v-for="item in origins" :key="item.value" :label="item.label" :value="item.value"></el-option>
                        </el-select>
                    </div>
                </div>
                <div class="query-cont__col">
                    <div class="query-col__label">经营区域：</div>
                    <div class="query-col__input">
                        <el-select v-model="queryParams.provinceId" @change="onProvince" placeholder="省" clearable>
                            <el-option v-for="item in provinceList" :key="item.id" :label="item.name" :value="item.provinceId">
                            </el-option>
                        </el-select>

                    </div>
                    <span class="ml10 mr10">-</span>
                    <div class="query-col__input">
                        <el-select v-model="queryParams.cityId" @change="onCity" placeholder="市" clearable>
                            <el-option v-for="item in cityList" :key="item.cityId" :label="item.name" :value="item.cityId">
                            </el-option>
                        </el-select>
                    </div>
                </div>
                <div class="query-cont__col">
                    <div class="query-col__label">主营品类：</div>
                    <div class="query-col__input">
                        <el-select v-model="queryParams.deviceCategory" placeholder="请选择" clearable>
                            <el-option v-for="item in devieCategorys" :key="item.value" :label="item.label" :value="item.value"></el-option>
                        </el-select>
                    </div>
                </div>
                <div class="query-cont__col">
                    <div class="query-col__label">主营品牌：</div>
                    <div class="query-col__input">
                        <el-input v-model="queryParams.deviceBrand" placeholder="请输入主营品牌" maxlength="50" clearable></el-input>
                    </div>
                </div>
                <div class="query-cont__col">
                    <div class="query-col__label">创建时间：</div>
                    <div class="query-col__input">
                        <el-date-picker v-model="queryParams.startTime" type="datetime" placeholder="开始时间" format="yyyy-MM-dd HH:mm" :picker-options="pickerOptionsStart"></el-date-picker>
                        <span class="ml10 mr10">-</span>
                        <el-date-picker v-model="queryParams.endTime" type="datetime" placeholder="结束时间" format="yyyy-MM-dd HH:mm" :picker-options="pickerOptionsEnd"></el-date-picker>
                    </div>
                </div>
                <div class="query-cont__col">
                    <div class="query-col__label">是否有客户经理：</div>
                    <div class="query-col__input">
                        <el-select v-model="queryParams.customer" placeholder="请选择" clearable>
                            <el-option label="是" value='1'></el-option>
                            <el-option label="否" value='2'></el-option>
                        </el-select>
                    </div>
                </div>
                <div class="query-cont__col">
                    <el-checkbox class="query-col__label" v-model="queryParams.removeDuplicate">去重合并</el-checkbox>
                </div>

                <div class="query-cont__col">
                    <h-button type="primary" @click="findThreadList">
                        查询
                    </h-button>
                    <h-button type="primary" @click="addThread">
                        新增客户线索
                    </h-button>
                </div>
            </div>
            <el-tag size="medium" class="eltagtop" style="margin-right:10px">
                已经筛选{{page.total}}个，累计线索数{{page.currentTotal}}个
            </el-tag>
            <el-tag size="medium" class="eltagtop">
                已经选中{{selectThread.length}}个，可进行批量操作
                <h-button table :disabled='selectThread.length === 0' style="margin-left:10px" @click="distributor()">批量分配销售</h-button>
            </el-tag>
            <hosJoyTable ref="hosjoyTable" align="center" border stripe showPagination :column="tableLabel" :data="tableData" :pageNumber.sync="queryParams.pageNumber" :pageSize.sync="queryParams.pageSize" :total="page.total" @pagination="pagination" @selection-change="dialogCheckChange"
                actionWidth='220' isShowselection isAction :isActionFixed='tableData&&tableData.length>0'>
                <template #deviceCategory="slotProps">
                    {{deviceCategoryString(slotProps.data.row.deviceCategory)}}
                </template>
                <template #customerName="slotProps">

                    <div>{{slotProps.data.row.customerName&&slotProps.data.row.customerName.length > 0 ? slotProps.data.row.customerName :'-'}}</div>
                    <div>{{slotProps.data.row.customerMobile}}</div>
                </template>
                <template #cityName="slotProps">
                    {{getCityString(slotProps.data.row)}}
                </template>
                <template #action="slotProps">
                    <h-button table @click="distributor(slotProps.data.row)">分配客户经理</h-button>
                    <h-button table @click="viewDetail(slotProps.data.row)">查看详情</h-button>
                </template>
            </hosJoyTable>

            <el-dialog title="分配销售" :visible.sync="distributorVisible" width="30%" :before-close="clearDispatchFormData">
                <span>分配后，该线索将分配给该客户经理</span>
                <el-form :model="distributorForm" :rules="rules" ref="distributorForm" label-width="130px" class="demo-ruleForm">
                    <el-form-item label="分配给客户经理" prop="customerMobile" ref='customerMobile'>
                        <el-autocomplete v-model="stateN" :fetch-suggestions="querySearchAsync" placeholder="请输入员工" @blur="onBlurItem" :trigger-on-focus="false" @select="handleSelect">
                            <template slot-scope="{ item }">
                                <div class="autoflex">
                                    <div class="name">{{ item.psnname }}</div>
                                    <span class="addr">{{ item.mobile }}</span>
                                </div>
                            </template>
                        </el-autocomplete>
                    </el-form-item>
                    <el-form-item label="所属部门" prop="customerDeptName">
                        <el-input placeholder="所属部门" disabled v-model='distributorForm.customerDeptName'></el-input>
                    </el-form-item>
                </el-form>
                <span slot="footer" class="dialog-footer">
                    <h-button @click="clearDispatchFormData">取消</h-button>
                    <h-button type="primary" @click="distributorSubmit">确定</h-button>
                </span>
            </el-dialog>
            <el-dialog title="新增线索" :visible.sync="threadVisible" width="50%" :before-close="clearthreadFormData">
                <el-form :model="threadForm" :rules="rules" ref="threadForm" label-width="130px">
                    <div class="add-cont__row">
                        <el-form-item prop='userMobile' label="客户手机号：">
                            <el-input placeholder="请输入客户手机号" @blur='phoneBlur' maxlength="11" v-model='threadForm.userMobile'></el-input>
                        </el-form-item>
                    </div>
                    <div class="add-cont__row">
                        <el-form-item prop='userName' label="客户姓名：">
                            <el-input placeholder="请输入客户姓名" maxlength="20" v-model='threadForm.userName'></el-input>
                        </el-form-item>
                    </div>
                    <div class="add-cont__row">
                        <el-form-item label="企业名称：">
                            <el-input placeholder="请输入企业名称" maxlength="50" v-model='threadForm.companyName'></el-input>
                        </el-form-item>
                    </div>
                    <div class="add-cont__row city-select">
                        <el-form-item label="">
                            <div slot="label" style="line-height: 20px;"> 客户地址：</div>
                            <el-select v-model="threadForm.provinceId" @change="onProvinceAdd" placeholder="省" clearable>
                                <el-option v-for="item in provinceList" :key="item.id" :label="item.name" :value="item.provinceId">
                                </el-option>
                            </el-select>
                            <span class="ml10 mr10">-</span>
                            <el-select v-model="threadForm.cityId" @change="onCityAdd" placeholder="市" clearable>
                                <el-option v-for="item in cityList" :key="item.cityId" :label="item.name" :value="item.cityId">
                                </el-option>
                            </el-select>
                            <span class="ml10 mr10">-</span>
                            <el-select v-model="threadForm.countryId" @change="onAreaAdd" placeholder="区" clearable>
                                <el-option v-for="item in countryList" :key="item.countryId" :label="item.name" :value="item.countryId">
                                </el-option>
                            </el-select>
                        </el-form-item>

                    </div>
                    <div class="add-cont__row">
                        <el-form-item label="">
                            <el-input v-model="threadForm.address" maxlength="100" placeholder="请输入详细地址"></el-input>
                        </el-form-item>
                    </div>
                    <div class="add-cont__row">
                        <el-form-item label="">
                            <div slot="label">主营品类：</div>
                            <el-select v-model="threadForm.deviceCategory" placeholder="请选择">
                                <el-option v-for="item in devieCategorys" :key="item.value" :label="item.label" :value="item.value"></el-option>
                            </el-select>
                        </el-form-item>
                    </div>
                    <div class="add-cont__row">
                        <el-form-item label="主营品牌：">
                            <el-input placeholder="请输入主营品牌" v-model='threadForm.deviceBrand'></el-input>
                        </el-form-item>
                    </div>
                    <div class="add-cont__row">
                        <div class="query-cont__col">
                            <el-form-item label="客户经理：">
                                <el-autocomplete v-model="stateN" :fetch-suggestions="querySearchAsync" placeholder="请选择客户经理" @blur="onBlurItem" :trigger-on-focus="false" @select="handleThreadSelect">
                                    <template slot-scope="{ item }">
                                        <div class="autoflex">
                                            <div class="name">{{ item.psnname }}</div>
                                        </div>
                                    </template>
                                </el-autocomplete>
                            </el-form-item>
                        </div>

                        <div class="query-cont__col">
                            <el-form-item label="客户经理手机号：">
                                <el-input placeholder="请输入客户经理手机号" disabled v-model='threadForm.customerMobile'></el-input>
                            </el-form-item>
                        </div>
                    </div>
                    <div class="add-cont__row">
                        <div class="query-cont__col">
                            <el-form-item label="所属部门：">
                                <el-input placeholder="请输入客户经理所属部门" disabled v-model='threadForm.customerDeptName'></el-input>
                            </el-form-item>
                        </div>
                    </div>
                </el-form>
                <span slot="footer" class="dialog-footer">
                    <h-button @click="clearthreadFormData">取消</h-button>
                    <h-button type="primary" @click="addThreadSubmit">确定</h-button>
                </span>
            </el-dialog>
            <detail :drawer='drawer' :threadDetail='threadDetail' :formRules='rules' @getDetail='getDetail' @handleClose="()=>drawer = false" v-if="drawer" />
        </div>
    </div>
</template>
<script lang='tsx'>
import { Vue, Component, Prop, Watch, Ref } from 'vue-property-decorator'
import { State, namespace, Getter, Action } from 'vuex-class'
import { getChiness, getThreadList, assignmentCustomer, getThreadDetail, createThread, getThreadListCount, checkThreadIsRight } from './api/index'
import detail from './detail.vue'
import hosJoyTable from '@/components/HosJoyTable/hosjoy-table.vue'
import { ThreadQeuryModel } from './const/model'
import { THREAD_ORIGIN, DEVICE_CATEGORY } from './const/index'
import { Clue, RespBossCluePage } from '@/interface/hbp-member'
import { Phone } from '@/utils/rules'

@Component({
    name: 'Thread',
    components: {
        hosJoyTable, detail
    }
})
export default class Thread extends Vue {
    @State('userInfo') userInfo: any
    @Action('crmmanage/findCrmdeplist') findCrmdeplist: Function
    @Action('vipApply/findContract') findContract: Function
    @Getter('vipApply/contracts') contracts: any
    // @Getter('crmmanage/crmdepList') branchArr: any
    @Ref('distributorForm') readonly distributorRef!: HTMLFormElement;
    @Ref('customerMobile') readonly customerMobileRef!: HTMLFormElement;
    @Ref('threadForm') readonly threadFormRef!: HTMLFormElement;
    @Ref('hosjoyTable') readonly hosjoyTableRef!: HTMLFormElement;
    @Watch('distributorForm.customerMobile')
    onFormChanged (newValue: string, oldValue: string) {
        this.$nextTick(() => {
            if (newValue) this.customerMobileRef.clearValidate()
        })
    }

    @Watch('queryParams.provinceId')
    onCityChange (newVal) {
        this.cityList = this.getCity(newVal)
    }

    @Watch('threadForm.provinceId')
    onThreadCityChange (newVal, oldVal) {
        if (newVal && newVal.length > 0) {
            this.cityList = this.getCity(newVal)
        }
    }

    @Watch('threadForm.cityId')
    onThreadCountryChange (newVal, oldVal) {
        if (newVal && newVal.length > 0) {
            this.countryList = this.getCountry(newVal)
        }
    }

    queryParams: ThreadQeuryModel = {
        provinceId: '',
        cityId: '',
        companyName: '',
        customer: null,
        deviceBrand: '',
        deviceCategory: null,
        startTime: '',
        endTime: '',
        origin: null,
        pageNumber: 1,
        pageSize: 10,
        userMobile: '',
        userName: '',
        removeDuplicate: true
    }
    tableLabel: tableLabelProps = [
        { label: '客户手机号', prop: 'userMobile', width: '120' },
        { label: '客户姓名', prop: 'userName', width: '120' },
        { label: '企业名称', prop: 'companyName', width: '200' },
        { label: '创建人', prop: 'createBy', width: '120' },
        { label: '创建时间', prop: 'createTime', width: '130', displayAs: 'YYYY-MM-DD HH:mm' },
        { label: '所在城市', prop: 'cityName', slot: 'cityName', width: '120' },
        { label: '所属分部', prop: 'customerDeptName', width: '120' },
        { label: '主营品牌', prop: 'deviceBrand', width: '120' },
        { label: '主营品类', prop: 'deviceCategory', slot: 'deviceCategory', width: '120' },
        { label: '客户经理', prop: 'customerName', slot: 'customerName', width: '120' }
    ]
    rules = {
        customerMobile: [
            { required: true, message: '请选择分配员工', trigger: 'blur' }
        ],
        customerDeptName: [
            { required: true, message: '请选择分部', trigger: 'change' }
        ],
        userMobile: [
            { required: true, message: '请输入客户手机', trigger: 'blur' },
            { validator: Phone, message: '请输入正确手机号', trigger: 'blur' }
        ],
        userName: [
            { required: true, message: '请输入客户姓名', trigger: 'blur' }
        ]
    }
    page = {
        sizes: [10, 20, 50, 100],
        currentTotal: 0,
        total: 0
    }
    origins = THREAD_ORIGIN
    devieCategorys = DEVICE_CATEGORY
    provinceList: any[] = []
    cityList: any[] = []
    countryList: any[] = []
    tableData: RespBossCluePage[] = []
    currentThread: RespBossCluePage = null
    canDispatchList: string[] = []
    threadDetail: Clue = {}
    distributorVisible: boolean = false
    isPagination: boolean = false
    threadVisible: boolean = false
    isloading: boolean = false
    drawer: boolean = false
    distributorForm: { customerMobile: string, customerName: string, clueId: string[], customerDeptName: string } = {
        customerName: '',
        customerMobile: '',
        clueId: [],
        customerDeptName: ''
    }
    threadForm: Clue = {
        provinceId: '',
        cityId: '',
        countryId: ''
    }
    selectThread: Clue[] = []
    timeout = null
    stateN: string = ''

    get pickerOptionsStart () {
        return {
            disabledDate: time => {
                let beginDateVal = this.queryParams.endTime
                if (beginDateVal) {
                    return (
                        time.getTime() > new Date(beginDateVal).getTime()
                    )
                }
            }
        }
    }
    get pickerOptionsEnd () {
        return {
            disabledDate: time => {
                let beginDateVal = this.queryParams.startTime
                if (beginDateVal) {
                    return (
                        time.getTime() < new Date(beginDateVal).getTime() - 8.64e7
                    )
                }
            }
        }
    }

    get deviceCategoryString () {
        return deviceCategory => {
            const filters = this.devieCategorys.filter((item: { value: string, label: string }) => {
                return item.value === deviceCategory
            })
            if (filters.length > 0) {
                return filters[0].label
            }
            return '-'
        }
    }

    get getCityString () {
        return (row: Clue) => {
            if (row.provinceName && row.cityName) {
                return row.provinceName + row.cityName
            }
            return '-'
        }
    }
    get getCity () {
        return id => {
            const province = this.provinceList.filter(item => item.provinceId === id)
            if (province.length > 0) {
                return province[0].cities
            }
            return []
        }
    }
    get getCountry () {
        return id => {
            const city = this.cityList.filter(item => item.cityId == id)
            if (city.length > 0) {
                return city[0].countries
            }
            return []
        }
    }
    onProvince (key) {
        this.queryParams.provinceId = key || ''
        this.queryParams.cityId = ''
    }

    onCity (key) {
        this.queryParams.cityId = key || ''
    }

    onProvinceAdd (key) {
        this.threadForm.provinceId = key || ''
        this.threadForm.cityId = null
        this.threadForm.countryId = ''
        if (key.length > 0) {
            const province = this.provinceList.filter(item => {
                return item.provinceId === this.threadForm.provinceId
            })
            this.threadForm.provinceName = province.length > 0 ? province[0].name : ''
        }
    }

    onCityAdd (key) {
        if (key.length > 0) {
            const city = this.cityList.filter(item => {
                return item.cityId === this.threadForm.cityId
            })
            this.threadForm.cityName = city.length > 0 ? city[0].name : ''
            this.threadForm.cityId = key || ''
            this.threadForm.countryId = ''
        }
        console.log(this.threadForm)
    }

    onAreaAdd (key) {
        this.threadForm.countryId = key
        if (key.length > 0) {
            const country = this.countryList.filter(item => {
                return item.countryId === this.threadForm.countryId
            })
            this.threadForm.countryName = country.length > 0 ? country[0].name : ''
        }
    }

    async getAreacode () {
        const { data } = await getChiness()
        this.provinceList = data || []
    }

    onBlurItem () {

    }

    phoneBlur (e) {
        console.log(this.threadForm.userMobile)
        Phone('', this.threadForm.userMobile, async e => {
            if (!e) {
                const { data } = await checkThreadIsRight(this.threadForm.userMobile)
                if (data) {
                    // 表示已经注册过
                    this.threadForm.userMobile = ''
                    this.$message.error('CRM中已有该客户，无需重复添加')
                }
            }
        })
    }

    // async onGetbranch () {
    //     await this.findCrmdeplist({ deptType: 'F', pkDeptDoc: this.userInfo.pkDeptDoc, jobNumber: this.userInfo.jobNumber, authCode: sessionStorage.getItem('authCode') ? JSON.parse(sessionStorage.getItem('authCode')) : '' })
    // }

    async querySearchAsync (queryString, cb) {
        if (queryString) {
            await this.findContract(queryString)
            var restaurants = this.contracts
            var results = queryString ? restaurants.filter(this.createStateFilter(queryString)) : restaurants
            clearTimeout(this.timeout)
            this.timeout = setTimeout(() => {
                cb(results)
            }, 3000 * Math.random())
        }
    }
    createStateFilter (queryString) {
        return (state) => {
            return (state.psnname.indexOf(queryString) === 0)
        }
    }

    handleSelect (item) {
        this.stateN = item.psnname
        this.distributorForm.customerMobile = item.mobile
        this.distributorForm.customerName = item.psnname
        this.distributorForm.customerDeptName = item.deptName
    }

    handleThreadSelect (item) {
        this.stateN = item.psnname
        this.threadForm.customerMobile = item.mobile
        this.threadForm.customerName = item.psnname
        this.threadForm.customerDeptName = item.deptName
    }

    dialogCheckChange (item) {
        if (!this.isPagination) {
            this.selectThread = item
        }
        this.isPagination = false
    }

    async findThreadList () {
        const { data } = await getThreadList(this.queryParams)
        this.tableData = data.records
        this.page.total = data.total
        const { data: count } = await getThreadListCount({})
        this.page.currentTotal = count
        if (this.selectThread && this.selectThread.length > 0) {
            this.selectThread.forEach(row => {
                this.tableData.forEach(rowData => {
                    if (row.id === rowData.id) {
                        this.hosjoyTableRef.toggleRowSelection(rowData)
                    }
                })
            })
        } else {
            this.hosjoyTableRef.clearSelection()
        }
    }

    pagination () {
        this.isPagination = true
        this.findThreadList()
    }

    addThread () {
        this.threadVisible = true
    }

    distributor (val: RespBossCluePage) {
        this.currentThread = val
        if (val) {
            this.canDispatchList = [this.currentThread.id.toString()]
        } else {
            this.canDispatchList = this.selectThread.map(item => {
                return item.id.toString()
            })
        }
        this.distributorVisible = true
    }

    async distributorSubmit () {
        this.distributorForm.clueId = this.canDispatchList
        this.isloading = true
        this.distributorRef.validate(async (valid) => {
            if (valid) {
                try {
                    await assignmentCustomer(this.distributorForm)
                    this.clearDispatchFormData()
                    this.isloading = false
                    this.$message({
                        message: `销售分配成功`,
                        type: 'success'
                    })
                    this.distributorForm = {
                        customerName: '',
                        customerMobile: '',
                        clueId: [],
                        customerDeptName: ''
                    }
                    this.findThreadList()
                } catch (error) {
                    this.isloading = false
                }
            } else {
                this.isloading = false
            }
        })
    }

    async addThreadSubmit () {
        this.threadForm.createBy = this.userInfo.employeeName
        this.threadForm.createPhone = this.userInfo.phoneNumber
        this.threadForm.origin = 5
        this.threadFormRef.validate(async (valid) => {
            if (valid) {
                try {
                    await createThread(this.threadForm)
                    this.clearthreadFormData()
                    this.isloading = false
                    this.$message({
                        message: `保存线索成功`,
                        type: 'success'
                    })
                    this.findThreadList()
                } catch (error) {
                    this.isloading = false
                }
            } else {
                this.isloading = false
            }
        })
    }

    clearthreadFormData () {
        this.threadForm = {
            provinceId: '',
            cityId: '',
            countryId: ''
        }
        this.$nextTick(() => {
            this.threadFormRef.clearValidate()
        })
        this.threadVisible = false
    }

    clearDispatchFormData () {
        this.stateN = ''
        this.distributorForm = {
            customerName: '',
            customerMobile: '',
            clueId: [],
            customerDeptName: ''
        }
        this.$nextTick(() => {
            this.distributorRef.clearValidate()
        })
        this.distributorVisible = false
    }

    getDetail () {
        this.findThreadList()
        this.drawer = false
    }

    async viewDetail (val: RespBossCluePage) {
        this.currentThread = val
        const { data } = await getThreadDetail(val.id)
        this.threadDetail = data
        this.drawer = true
        console.log(data)
    }

    async mounted () {
        this.getAreacode()
        // this.onGetbranch()
        this.findThreadList()
    }
}
</script>
<style lang='scss' scoped>
@import "./css/list.scss";
</style>
